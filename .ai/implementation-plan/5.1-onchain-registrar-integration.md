## **5.1 OnchainRegistrar Integration with AstralSDK**  
  *Description*: Complete the integration of the OnchainRegistrar with the AstralSDK class to fully support onchain location proof creation, verification, and revocation workflows. First, we must fix the async initialization pattern that's blocking tests.

   - *Branch Setup*:
     - [x] Create new branch: `phase/5.1-onchain-registrar-integration`
     - [x] Ensure we're branching from `main` with latest changes
   
   - *Tasks*: 
     
     ### **Task 1: Fix Async Initialization Pattern** (CRITICAL BLOCKER)
     - [ ] Fix OffchainSigner async initialization:
       - [ ] Remove async `initializeEASModules()` call from constructor
       - [ ] Make `initializeEASModules()` synchronous OR
       - [ ] Create static factory method: `static async create(config): Promise<OffchainSigner>`
       - [ ] Update all usages to use the new pattern
       - [ ] Ensure tests pass for OffchainSigner
     - [ ] **Commit checkpoint**: `fix(eas): refactor OffchainSigner to handle async initialization properly`
     
     - [ ] Fix OnchainRegistrar async initialization:
       - [ ] Apply same pattern as OffchainSigner
       - [ ] Ensure consistency between both classes
       - [ ] Update all usages
       - [ ] Ensure tests pass for OnchainRegistrar
     - [ ] **Commit checkpoint**: `fix(eas): refactor OnchainRegistrar to handle async initialization properly`
     
     - [ ] Fix AstralApiClient test import:
       - [ ] Change `import { expect } from 'chai'` to use Jest's expect
       - [ ] Ensure all assertions use Jest syntax
     - [ ] **Commit checkpoint**: `fix(test): update AstralApiClient tests to use Jest instead of chai`
     
     - [ ] Verify all tests pass:
       - [ ] Run `pnpm test`
       - [ ] Fix any remaining test issues
     - [ ] **Commit checkpoint**: `test: ensure all tests pass after async initialization fixes`

     ### **Task 2: AstralSDK OnchainRegistrar Integration**
     - [ ] Update AstralSDK class structure:
       - [ ] Add `private onchainRegistrar?: OnchainRegistrar` property
       - [ ] Update constructor to handle OnchainRegistrar initialization
       - [ ] Account for the new async initialization pattern
       - [ ] Add debug logging for initialization
     - [ ] **Commit checkpoint**: `feat(sdk): add OnchainRegistrar property and initialization setup`

     - [ ] Implement `ensureOnchainRegistrarInitialized` method:
       - [ ] Create private method for lazy initialization
       - [ ] Handle async initialization if using factory pattern
       - [ ] Validate provider/signer availability
       - [ ] Add appropriate error handling
     - [ ] **Commit checkpoint**: `feat(sdk): implement ensureOnchainRegistrarInitialized method`

     ### **Task 3: Implement Onchain Methods**
     - [ ] Complete `createOnchainLocationProof` method:
       - [ ] Implement full method with initialization check
       - [ ] Add comprehensive error handling
       - [ ] Add debug logging
       - [ ] Write unit tests
     - [ ] **Commit checkpoint**: `feat(sdk): implement createOnchainLocationProof method`

     - [ ] Implement `verifyOnchainLocationProof` method:
       - [ ] Implement full method with initialization check
       - [ ] Return proper VerificationResult
       - [ ] Add error handling and logging
       - [ ] Write unit tests
     - [ ] **Commit checkpoint**: `feat(sdk): implement verifyOnchainLocationProof method`

     - [ ] Implement `revokeOnchainLocationProof` method:
       - [ ] Implement full method with initialization check
       - [ ] Add revocability check
       - [ ] Add error handling and logging
       - [ ] Write unit tests
     - [ ] **Commit checkpoint**: `feat(sdk): implement revokeOnchainLocationProof method`

     ### **Task 4: Testing and Examples**
     - [ ] Write comprehensive integration tests:
       - [ ] Test all onchain methods
       - [ ] Test error scenarios
       - [ ] Test with mock providers
     - [ ] **Commit checkpoint**: `test(sdk): add comprehensive tests for onchain integration`

     - [ ] Update example files:
       - [ ] Update onchain-workflow-example.ts
       - [ ] Add error handling examples
       - [ ] Document the new initialization pattern
     - [ ] **Commit checkpoint**: `docs(examples): update onchain examples with new patterns`

     ### **Task 5: Clean Up and Finalize**
     - [ ] Remove console.log statements:
       - [ ] Replace with proper debug logging
       - [ ] Ensure no console statements remain
     - [ ] **Commit checkpoint**: `chore: remove console.log statements and add proper logging`
     
     - [ ] Final quality checks:
       - [ ] Run `pnpm run lint` and fix any issues
       - [ ] Run `pnpm run typecheck`
       - [ ] Run `pnpm test`
       - [ ] Review all changes for consistency
     - [ ] **Commit checkpoint**: `chore: final cleanup and quality checks for onchain integration`

   - [ ] *Output*: A fully functional integration between AstralSDK and OnchainRegistrar, supporting the complete onchain workflow for location proofs.
   
   - *Technical considerations*: 
     - [ ] Maintain clear workflow separation between offchain and onchain methods
     - [ ] Ensure proper error propagation from OnchainRegistrar to AstralSDK
     - [ ] Consider gas estimation and transaction parameter overrides
     - [ ] Handle chain-specific configuration differences
     - [ ] Support both connected and disconnected states gracefully
     - [ ] Consider transaction confirmation strategies (wait for receipt vs return after submission)
     - [ ] Document chain requirements and limitations
     - [ ] Add appropriate warnings for testnet vs mainnet usage
     - [ ] Consider transaction retry mechanisms for failed operations
     - [ ] Add clear debugging and logging to help troubleshoot blockchain operations

   - [ ] Run linting: `pnpm run lint`
   - [ ] Run typechecking: `pnpm run typecheck`
   - [ ] Run tests: `pnpm run test`
   - [ ] Commit changes with descriptive message

Complete: ⬜️

Commit hash: <todo>

## Implementation Report:

[TODO]